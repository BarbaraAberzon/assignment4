name: assignment4

on:
  push:
    branches:
      - '*'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Record start time
        run: |
          echo "$(date -Iminutes);" > log.txt
          echo "Barbara Aberzon;" >> log.txt

      - name: Build pet-store image
        id: build_pet_store
        run: |
          docker build -t pet-store:latest -f Dockerfile.pet-store .

      - name: Log pet-store build result
        if: always()
        run: |
          if [ "${{ steps.build_pet_store.outcome }}" == "success" ]; then
            echo "image pet-store successfully built;" >> log.txt
          else
            echo "image pet-store not able to be built;" >> log.txt
          fi

      - name: Build pet-order image
        id: build_pet_order
        run: |
          docker build -t pet-order:latest -f Dockerfile.pet-order .

      - name: Log pet-order build result
        if: always()
        run: |
          if [ "${{ steps.build_pet_order.outcome }}" == "success" ]; then
            echo "image pet-order successfully built;" >> log.txt
          else
            echo "image pet-order not able to be built;" >> log.txt
          fi

      - name: Save Docker images
        run: |
          docker save pet-store:latest -o pet-store.tar
          docker save pet-order:latest -o pet-order.tar

      - name: Upload pet-store image artifact
        uses: actions/upload-artifact@v4
        with:
          name: pet-store-image
          path: pet-store.tar

      - name: Upload pet-order image artifact
        uses: actions/upload-artifact@v4
        with:
          name: pet-order-image
          path: pet-order.tar

      - name: Upload log artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: log.txt

  test:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build log
        uses: actions/download-artifact@v4
        with:
          name: build-log

      - name: Download pet-store image
        uses: actions/download-artifact@v4
        with:
          name: pet-store-image

      - name: Download pet-order image
        uses: actions/download-artifact@v4
        with:
          name: pet-order-image

      - name: Load Docker images
        run: |
          docker load -i pet-store.tar
          docker load -i pet-order.tar

      - name: Create Docker network
        run: docker network create petstore-network

      - name: Start MongoDB for pet stores
        run: |
          docker run -d --name mongodb-petstore \
            --network petstore-network \
            -p 27017:27017 \
            mongo:5.0
          sleep 10

      - name: Start MongoDB for orders
        run: |
          docker run -d --name mongodb-orders \
            --network petstore-network \
            -p 27018:27017 \
            mongo:5.0
          sleep 10

      - name: Start pet-store1 container
        id: pet_store1
        continue-on-error: true
        run: |
          docker run -d --name pet-store1 \
            --network petstore-network \
            -p 5001:5001 \
            -e MONGO_URI=mongodb://mongodb-petstore:27017/ \
            -e DB_NAME=petstore \
            -e STORE_ID=1 \
            pet-store:latest
          sleep 5

      - name: Start pet-store2 container
        id: pet_store2
        continue-on-error: true
        run: |
          docker run -d --name pet-store2 \
            --network petstore-network \
            -p 5002:5001 \
            -e MONGO_URI=mongodb://mongodb-petstore:27017/ \
            -e DB_NAME=petstore \
            -e STORE_ID=2 \
            pet-store:latest
          sleep 5

      - name: Start pet-order container
        id: pet_order
        continue-on-error: true
        run: |
          docker run -d --name pet-order \
            --network petstore-network \
            -p 5003:5003 \
            -e MONGO_URI=mongodb://mongodb-orders:27017/ \
            -e PET_STORE_1_URL=http://pet-store1:5001 \
            -e PET_STORE_2_URL=http://pet-store2:5001 \
            -e PORT=5003 \
            pet-order:latest
          sleep 5

      - name: Log container status
        run: |
          if [ "${{ steps.pet_store1.outcome }}" == "success" ]; then
            echo "Container pet-store #1 up and running;" >> log.txt
          else
            echo "Container pet-store #1 failed to run;" >> log.txt
          fi

          if [ "${{ steps.pet_store2.outcome }}" == "success" ]; then
            echo "Container pet-store #2 up and running;" >> log.txt
          else
            echo "Container pet-store #2 failed to run;" >> log.txt
          fi

          if [ "${{ steps.pet_order.outcome }}" == "success" ]; then
            echo "Container pet-order up and running;" >> log.txt
          else
            echo "Container pet-order failed to run;" >> log.txt
          fi

      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to be ready..."
          sleep 10

          for i in {1..30}; do
            if curl -s http://localhost:5001/ > /dev/null; then
              echo "pet-store1 is ready"
              break
            fi
            echo "Waiting for pet-store1... ($i)"
            sleep 2
          done

          for i in {1..30}; do
            if curl -s http://localhost:5002/ > /dev/null; then
              echo "pet-store2 is ready"
              break
            fi
            echo "Waiting for pet-store2... ($i)"
            sleep 2
          done

          for i in {1..30}; do
            if curl -s http://localhost:5003/ > /dev/null; then
              echo "pet-order is ready"
              break
            fi
            echo "Waiting for pet-order... ($i)"
            sleep 2
          done

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install pytest and requests
        run: pip install pytest requests

      - name: Run pytest
        id: pytest
        continue-on-error: true
        run: |
          cd tests
          pytest -v assn4_tests.py | tee assn4_test_results.txt

      - name: Log pytest result
        run: |
          if [ "${{ steps.pytest.outcome }}" == "success" ]; then
            echo "All pytests succeeded;" >> log.txt
          else
            echo "pytests failed;" >> log.txt
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: tests/assn4_test_results.txt

      - name: Upload updated log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: log-file
          path: log.txt
          overwrite: true

      - name: Stop containers
        if: always()
        run: |
          docker stop pet-order pet-store2 pet-store1 mongodb-orders mongodb-petstore || true
          docker rm pet-order pet-store2 pet-store1 mongodb-orders mongodb-petstore || true
          docker network rm petstore-network || true

      - name: Fail if tests failed
        if: steps.pytest.outcome != 'success'
        run: exit 1

  query:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download pet-store image
        uses: actions/download-artifact@v4
        with:
          name: pet-store-image

      - name: Download pet-order image
        uses: actions/download-artifact@v4
        with:
          name: pet-order-image

      - name: Load Docker images
        run: |
          docker load -i pet-store.tar
          docker load -i pet-order.tar

      - name: Create Docker network
        run: docker network create petstore-network

      - name: Start MongoDB for pet stores
        run: |
          docker run -d --name mongodb-petstore \
            --network petstore-network \
            -p 27017:27017 \
            mongo:5.0
          sleep 10

      - name: Start MongoDB for orders
        run: |
          docker run -d --name mongodb-orders \
            --network petstore-network \
            -p 27018:27017 \
            mongo:5.0
          sleep 10

      - name: Start pet-store1 container
        run: |
          docker run -d --name pet-store1 \
            --network petstore-network \
            -p 5001:5001 \
            -e MONGO_URI=mongodb://mongodb-petstore:27017/ \
            -e DB_NAME=petstore \
            -e STORE_ID=1 \
            pet-store:latest
          sleep 5

      - name: Start pet-store2 container
        run: |
          docker run -d --name pet-store2 \
            --network petstore-network \
            -p 5002:5001 \
            -e MONGO_URI=mongodb://mongodb-petstore:27017/ \
            -e DB_NAME=petstore \
            -e STORE_ID=2 \
            pet-store:latest
          sleep 5

      - name: Start pet-order container
        run: |
          docker run -d --name pet-order \
            --network petstore-network \
            -p 5003:5003 \
            -e MONGO_URI=mongodb://mongodb-orders:27017/ \
            -e PET_STORE_1_URL=http://pet-store1:5001 \
            -e PET_STORE_2_URL=http://pet-store2:5001 \
            -e PORT=5003 \
            pet-order:latest
          sleep 5

      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to be ready..."
          sleep 10

          for i in {1..30}; do
            if curl -s http://localhost:5001/ > /dev/null; then
              echo "pet-store1 is ready"
              break
            fi
            echo "Waiting for pet-store1... ($i)"
            sleep 2
          done

          for i in {1..30}; do
            if curl -s http://localhost:5002/ > /dev/null; then
              echo "pet-store2 is ready"
              break
            fi
            echo "Waiting for pet-store2... ($i)"
            sleep 2
          done

          for i in {1..30}; do
            if curl -s http://localhost:5003/ > /dev/null; then
              echo "pet-order is ready"
              break
            fi
            echo "Waiting for pet-order... ($i)"
            sleep 2
          done

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install requests
        run: pip install requests

      - name: Process queries from query.txt
        run: |
          python3 << 'EOF'
          import requests
          import json

          PET_STORE_1_URL = "http://localhost:5001"
          PET_STORE_2_URL = "http://localhost:5002"
          PET_ORDER_URL = "http://localhost:5003"

          # Process query.txt - only execute what's in the file
          with open("query.txt", "r") as f:
              content = f.read()

          results = []
          for entry in content.split(";"):
              entry = entry.strip()
              if not entry: continue

              if entry.startswith("query:"):
                  parts = entry[6:].strip().split(",", 1)
                  store_url = PET_STORE_1_URL if parts[0].strip() == "1" else PET_STORE_2_URL
                  r = requests.get(f"{store_url}/pet-types?{parts[1].strip()}")
                  results.append((r.status_code, r.json() if r.status_code == 200 else None))

              elif entry.startswith("purchase:"):
                  data = json.loads(entry[9:].strip())
                  r = requests.post(f"{PET_ORDER_URL}/purchases", json=data)
                  results.append((r.status_code, r.json() if r.status_code == 201 else None))

          # Write response.txt
          with open("response.txt", "w") as f:
              for code, payload in results:
                  f.write(f"{code}\n")
                  f.write("NONE\n" if payload is None else json.dumps(payload, indent=2) + "\n")
                  f.write(";\n")
          EOF

      - name: Upload response file
        uses: actions/upload-artifact@v4
        with:
          name: response-file
          path: response.txt

      - name: Stop containers
        if: always()
        run: |
          docker stop pet-order pet-store2 pet-store1 mongodb-orders mongodb-petstore || true
          docker rm pet-order pet-store2 pet-store1 mongodb-orders mongodb-petstore || true
          docker network rm petstore-network || true
